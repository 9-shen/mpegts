<!DOCTYPE html>
<html>
<head>
	<title>MPEG-TS Parser demo</title>
	<script src="/jDataView/src/jdataview.js"></script>
	<script src="/jBinary/src/jbinary.js"></script>
	<script src="mpegts.js"></script>
	<script src="mp4.js"></script>
	<script src="h264.js"></script>
	<style type="text/css">
		.jsonContainer { color: #733; font-style: italic; word-wrap: break-word; display: block; float: left; width: 45%; margin-right: 2%; overflow-x: scroll; }
		.jsonValue { color: #373; font-weight: bold; font-style: normal; }
	</style>
</head>
<body>
	<video id="video" controls></video>
	<a id="url">Download</a>

	<script>
		if (!('time' in console)) {
			(function () {
				var timeStarts = {}, nowHost = typeof performance !== 'undefined' ? performance : Date;
				console.time = function (id) {
					timeStarts[id] = nowHost.now();
				};
				console.timeEnd = function (id) {
					console.log(id + ': ' + (nowHost.now() - timeStarts[id]) + ' ms');
					document.title = id + ': ' + (nowHost.now() - timeStarts[id]) + ' ms';
					delete timeStarts[id];
				};
			})();
		}

		MPEGTS.loadFrom('chunk-5020.ts', function () {
			console.time('convert');

			console.time('read');
			var packets = this.read();
			console.timeEnd('read');

			console.time('getStream');
			var stream = new jDataView(this.binary.view.byteLength), STTS = [], lastSTTS, prevPTS, duration = 0;
			for (var i = 0, length = packets.length; i < length; i++) {
				var packet = packets[i], adaptation = packet.adaptationField, payload = packet.payload;
				if (adaptation && adaptation.pcr) {
					var pts = adaptation.pcr.pts;
					if (prevPTS) {
						var delta = pts - prevPTS;
						if (delta < 0) console.log(delta, pts, prevPTS);
						duration += delta;
						if (lastSTTS && lastSTTS.sample_delta === delta) {
							lastSTTS.sample_count++;
						} else {
							STTS.push(lastSTTS = {sample_count: 1, sample_delta: delta});
						}
					}
					prevPTS = pts;
				}
				if (payload && payload._rawStream) {
					stream.writeBytes(payload._rawStream);
				}
			}
			console.timeEnd('getStream');

			console.log(STTS, duration);

			console.time('filter');
			var original = stream.getBytes(stream.tell(), 0, true, true), sps, pps, spsInfo, accessPoints = [], IDR = [], prevAccessPoint = 0, width, height;
			stream.seek(0);
			for (var i = 0, start = 0, streamId, length = original.length; i <= length; i++) {
				if (i === length || (original[i] === 0 && original[i + 1] === 0 && (original[i + 2] === 1 || (original[i + 2] === 0 && original[i + 3] === 1)))) {
					switch (streamId) {
						case 0x65:
							IDR.push(accessPoints.length + 1);
							break;

						case 0x67:
							if (!sps) {
								sps = original.slice(start, i);
								spsInfo = new jBinary(sps, H264).read('SPS');
								width = (spsInfo.pic_width_in_mbs_minus_1 + 1) * 16;
								height = (2 - spsInfo.frame_mbs_only_flag) * (spsInfo.pic_height_in_map_units_minus_1 + 1) * 16;
								var cropping = spsInfo.frame_cropping;
								if (cropping) {
									width -= 2 * (cropping.left + cropping.right);
									height -= 2 * (cropping.top + cropping.bottom);
								}
							}
							break;

						case 0x68:
							if (!pps) {
								pps = original.slice(start, i);
							}
							break;

						case 0x09:
							var pos = stream.tell();
							if (pos > prevAccessPoint) {
								accessPoints.push(pos - prevAccessPoint);
								prevAccessPoint = pos;
							}
							break;
					}
					if (i > start) {
						stream.writeUint32(i - start);
						stream.writeBytes(original.slice(start, i));
					}
					i += original[i + 2] ? 3 : 4;
					start = i;
					streamId = original[i];
				}
			}
			var pos = stream.tell();
			if (pos > prevAccessPoint) {
				accessPoints.push(pos - prevAccessPoint);
			}
			console.timeEnd('filter');

			console.time('build');
			var file = new MP4(stream.byteLength);
			file.write({
				ftyp: [{
					major_brand: 'isom',
					minor_version: 512,
					compatible_brands: ['isom', 'iso2', 'avc1', 'mp41']
				}],
				mdat: [{
					_rawData: stream.getBytes(stream.tell(), 0)
				}],
				moov: [{
					atoms: {
						mvhd: [{
							version: 0,
							flags: 0,
							timescale: 90000,
							duration: duration,
							rate: 1,
							volume: 1,
							matrix: {
								a: 1, b: 0, x: 0,
								c: 0, d: 1, y: 0,
								u: 0, v: 0, w: 1
							},
							next_track_ID: 2
						}],
						trak: [{
							atoms: {
								tkhd: [{
									version: 0,
									flags: 15,
									track_ID: 1,
									duration: duration,
									layer: 0,
									alternate_group: 0,
									volume: 1,
									matrix: {
										a: 1, b: 0, x: 0,
										c: 0, d: 1, y: 0,
										u: 0, v: 0, w: 1
									},
									dimensions: {
										horz: width,
										vert: height
									}
								}],
								edts: [{
									atoms: {
										elst: [{
											version: 0,
											flags: 0,
											entries: [{
												segment_duration: duration,
												media_time: 0,
												media_rate: 1
											}]
										}]
									}
								}],
								mdia: [{
									atoms: {
										mdhd: [{
											version: 0,
											flags: 0,
											timescale: 90000,
											duration: duration,
											lang: 'und'
										}],
										hdlr: [{
											version: 0,
											flags: 0,
											handler_type: 'vide',
											name: 'VideoHandler'
										}],
										minf: [{
											atoms: {
												vmhd: [{
													version: 0,
													flags: 1,
													graphicsmode: 0,
													opcolor: {r: 0, g: 0, b: 0}
												}],
												dinf: [{
													atoms: {
														dref: [{
															version: 0,
															flags: 0,
															entries: [{
																type: 'url ',
																version: 0,
																flags: 1,
																location: ''
															}]
														}]
													}
												}],
												stbl: [{
													atoms: {
														stsd: [{
															version: 0,
															flags: 0,
															entries: [{
																type: 'avc1',
																data_reference_index: 1,
																dimensions: {
																	horz: width,
																	vert: height
																},
																resolution: {
																	horz: 72,
																	vert: 72
																},
																frame_count: 1,
																compressorname: '',
																depth: 24,
																atoms: {
																	avcC: [{
																		version: 1,
																		profileIndication: spsInfo.profile_idc,
																		profileCompatibility: parseInt(spsInfo.constraint_set_flags.join(''), 2),
																		levelIndication: spsInfo.level_idc,
																		lengthSizeMinusOne: 3,
																		seqParamSets: [sps],
																		pictParamSets: [pps]
																	}]
																}
															}]
														}],
														stts: [{
															version: 0,
															flags: 0,
															entries: STTS
														}],
														stss: [{
															version: 0,
															flags: 0,
															entries: IDR
														}],
														stsc: [{
															version: 0,
															flags: 0,
															entries: [{
																first_chunk: 1,
																samples_per_chunk: accessPoints.length,
																sample_description_index: 1
															}]
														}],
														stsz: [{
															version: 0,
															flags: 0,
															sample_size: 0,
															sample_count: accessPoints.length,
															sample_sizes: accessPoints
														}],
														stco: [{
															version: 0,
															flags: 0,
															entries: [0x28]
														}]
													}
												}]
											}
										}]
									}
								}]
							}
						}]
					}
				}]
			});
			console.timeEnd('build');

			console.time('generateURL');
			document.getElementById('video').src =
			document.getElementById('url').href =
			new MP4(file.binary.view.slice(0, file.binary.tell())).toURL();
			console.timeEnd('generateURL');

			console.timeEnd('convert');
		});
	</script>
</body>
</html>
