<!DOCTYPE html>
<html>
<head>
	<title>MPEG-TS Parser demo</title>
</head>
<body>
	<canvas id="canvas"></canvas>

	<script>
		if (true || !('time' in console)) {
			(function () {
				var timeStarts = {}, nowHost = typeof performance !== 'undefined' && 'now' in performance ? performance : Date, avg = window.avg = {};
				console.time = function (id) {
					timeStarts[id] = nowHost.now();
				};
				console.timeEnd = function (id) {
					var delta = nowHost.now() - timeStarts[id];
					if (!(id in avg)) {
						avg[id] = {sum: 0, count: 0, valueOf: function () { return this.sum / this.count }};
					}
					avg[id].sum += delta;
					avg[id].count++;
					console.log(id + ': ' + delta + ' ms');
					delete timeStarts[id];
				};
			})();
		}

		var worker = new Worker('worker.js'), nextIndex = 0, sentVideos = 0, currentVideo = null, videos = [], lastOriginal, canvas = document.getElementById('canvas'), context = canvas.getContext('2d');

		var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || setTimeout;

		function nextFrame() {
			if (currentVideo.paused || currentVideo.ended) {
				return;
			}
			context.drawImage(currentVideo, 0, 0);
			requestAnimationFrame(nextFrame);
		}

		worker.addEventListener('message', function (event) {
			var data = event.data, descriptor = '#' + data.index + ': ' + data.original;

			switch (data.type) {
				case 'debug':
					Function.prototype.apply.call(console[data.action], console, data.args);
					return;

				case 'video':
					var video = document.createElement('video'), source = document.createElement('source');
					source.type = 'video/mp4';
					video.appendChild(source);
					
					video.addEventListener('canplaythrough', function () {
						console.log('converted ' + descriptor);
						videos[data.index] = this;
						if ((!currentVideo || currentVideo.ended) && data.index === nextIndex) {
							this.play();
						}
					});

					video.addEventListener('play', function () {
						if (currentVideo !== this) {
							if (!currentVideo) {
								canvas.width = this.width = this.videoWidth;
								canvas.height = this.height = this.videoHeight;
							}
							console.log('playing ' + descriptor);
							currentVideo = this;
							nextIndex++;
							if (sentVideos - nextIndex <= 1) {
								getMore();
							}
						}
						nextFrame();
					});

					video.addEventListener('ended', function () {
						delete videos[nextIndex - 1];
						if (nextIndex in videos) {
							videos[nextIndex].play();
						}
					});

					if (video.src.slice(0, 5) === 'blob:') {
						video.addEventListener('ended', function () {
							URL.revokeObjectURL(this.src);
						});
					}

					video.src = source.src = data.url;
					video.load();

					return;
			}
		});

		canvas.addEventListener('click', function () {
			if (currentVideo) {
				currentVideo.paused ? currentVideo.play() : currentVideo.pause();
			}
		});

		function getMore() {
			var ajax = new XMLHttpRequest();
			var manifest = 'http://mediamotiononline.ios.internapcdn.net/mediamotiononline/inapcms/CMS16042/flash/16042_adaptive2.mp4/CCURstream678422.m3u8';
			ajax.addEventListener('load', function () {
				var originals =
					this.responseText
					.split(/\r?\n/)
					.filter(RegExp.prototype.test.bind(/\.ts$/))
					.map(function (url) { return 'http://mediamotiononline.ios.internapcdn.net/mediamotiononline/inapcms/CMS16042/flash/16042_adaptive2.mp4/' + url });

				originals = originals.slice(originals.lastIndexOf(lastOriginal) + 1);
				lastOriginal = originals[originals.length - 1];

				worker.postMessage(originals.map(function (url, index) {
					return {url: url, index: sentVideos + index};
				}));

				sentVideos += originals.length;

				console.log('asked for ' + originals.length + ' more videos');
			});
			ajax.open('GET', manifest, true);
			ajax.send();
		}

		getMore();
	</script>
</body>
</html>
