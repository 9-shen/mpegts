<!DOCTYPE html>
<html>
<head>
	<title>MPEG-TS Parser demo</title>
	<script src="/jDataView/src/jdataview.js"></script>
	<script src="/jBinary/src/jbinary.js"></script>
	<script src="mp4.js"></script>
	<style type="text/css">
		#jsonContainer { color: #733; font-style: italic; word-wrap: break-word; }
		.jsonValue { color: #373; font-weight: bold; font-style: normal; }
	</style>
</head>
<body>
	<pre id="jsonContainer">
	</pre>
	<video id="video"></video>
	<a id="url"></a>
	<script>
		if (!('time' in console)) {
			var timeStarts = {};
			console.time = function (id) {
				timeStarts[id] = Date.now();
			};
			console.timeEnd = function (id) {
				console.log((Date.now() - timeStarts[id]) + ' ms');
				delete timeStarts[id];
			};
		}

		var mpegts = MP4.loadFrom('sample.mp4', function () {
			console.time('read');
			var data = this.read();
			console.timeEnd('read');

			var newVideo = new MP4(this.binary.view.byteLength);
			console.time('write');
			newVideo.write(data);
			var url = newVideo.binary.toURL();
			console.timeEnd('write');

			document.getElementById('jsonContainer').innerHTML =
				JSON.stringify(
					data,
					function (key, value) {
						if (key[0] === '_') return undefined;

						if (value instanceof Array && value.length > 10 && value.every(function (item) { return (item >= 0 && item <= 255) })) {
							value = value.map(function (value) {
								var str = value.toString(16).toUpperCase();
								return str.length == 2 ? str : '0' + str;
							}).join(' ');
						}

						return value instanceof Object ? value : '<span class=jsonValue>' + value + '</span>';
					},
					'    '
				);

			var source = document.createElement('source');
			source.type = 'video/mp4';
			source.src = this.binary.toURL(source.type);
			document.getElementById('video').appendChild(source);

			document.getElementById('url').href = document.getElementById('url').innerHTML = source.src;
		});
	</script>
</body>
</html>
