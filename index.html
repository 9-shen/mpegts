<!DOCTYPE html>
<html>
<head>
	<title>MPEG-TS Parser demo</title>
	<script src="/jDataView/src/jdataview.js"></script>
	<script src="/jBinary/src/jbinary.js"></script>
	<script src="mpegts.js"></script>
	<script src="mp4.js"></script>
	<style type="text/css">
		.jsonContainer { color: #733; font-style: italic; word-wrap: break-word; display: block; float: left; width: 45%; margin-right: 2%; overflow-x: scroll; }
		.jsonValue { color: #373; font-weight: bold; font-style: normal; }
	</style>
</head>
<body>
	<pre id="mpegts" class="jsonContainer">
	</pre>
	<pre id="mp4" class="jsonContainer">
	</pre>

	<script>
		if (!('time' in console)) {
			var timeStarts = {};
			console.time = function (id) {
				timeStarts[id] = Date.now();
			};
			console.timeEnd = function (id) {
				console.log((Date.now() - timeStarts[id]) + ' ms');
				delete timeStarts[id];
			};
		}

		function timeFor(name, callback) {
			console.time(name);
			callback();
			console.timeEnd(name);
		}

		[{name: 'MPEGTS', extension: 'ts'}, {name: 'MP4', extension: 'mp4'}].forEach(function (item) {
			self[item.name].loadFrom('sample.' + item.extension, function () {
				var data, file = this;
				timeFor(item.name + ' read', function () {
					data = file.read();
				});

				/*
				var newVideo = new MPEGTS(this.binary.view.byteLength);
				console.time('write');
				newVideo.write(data);
				var url = newVideo.binary.toURL();
				console.timeEnd('write');
				*/

				document.getElementById(item.name.toLowerCase()).innerHTML =
					JSON.stringify(
						data,
						function (key, value) {
							if (key[0] === '_') return;

							if (value instanceof Array && value.every(function (item) { return (item >= 0 && item <= 255) })) {
								value = value.map(function (value) {
									var str = value.toString(16).toUpperCase();
									return str.length == 2 ? str : '0' + str;
								}).join(' ');
							}

							return value instanceof Object ? value : '<span class=jsonValue>' + value + '</span>';
						},
						1
					);
			});
		});
	</script>
</body>
</html>
