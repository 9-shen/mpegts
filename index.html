<!DOCTYPE html>
<html>
<head>
	<title>MPEG-TS Parser demo</title>
</head>
<body>
	<canvas id="canvas"></canvas>

	<script>
		if (true || !('time' in console)) {
			(function () {
				var timeStarts = {}, nowHost = typeof performance !== 'undefined' && 'now' in performance ? performance : Date;
				console.time = function (id) {
					timeStarts[id] = nowHost.now();
				};
				console.timeEnd = function (id) {
					console.log(document.title = id + ': ' + (nowHost.now() - timeStarts[id]) + ' ms');
					delete timeStarts[id];
				};
			})();
		}

		var worker = new Worker('worker.js'), video = document.createElement('video'), source = document.createElement('source'), canvas = document.getElementById('canvas'), context;
		source.type = 'video/mp4';
		video.appendChild(source);

		var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || setTimeout;

		function nextFrame() {
			if (video.paused || video.ended) return;
			context.drawImage(video, 0, 0);
			requestAnimationFrame(nextFrame);
		}

		video.addEventListener('loadedmetadata', function () {
			canvas.width = video.width = video.videoWidth;
			canvas.height = video.height = video.videoHeight;
			canvas.style.border = '1px solid black';
			context = canvas.getContext('2d');
			video.play();
		});

		video.addEventListener('play', nextFrame);

		worker.addEventListener('message', function (event) {
			var data = event.data;
			switch (data.type) {
				case 'debug':
					console[data.action].apply(console, data.args);
					return;

				case 'video':
					console.timeEnd('converting');
					video.src = source.src = data.url;
					return;
			}
		});

		var ajax = new XMLHttpRequest();
		var manifest = 'http://localhost/hls/live/203739/NASATV1_iOS_HD/Edge.m3u8';
		ajax.addEventListener('load', function () {
			// TODO: change to more intelligent solution
			var files =
				this.responseText
				.split(/\r?\n/)
				.filter(RegExp.prototype.test.bind(/\.ts$/))
				.map(function (url) { return url.replace('nasahd-i.akamaihd.net', 'localhost') });

			console.log(files);

			worker.postMessage(files[0]);
		});
		ajax.open('GET', manifest, true);
		ajax.send();

		console.time('converting');
	</script>
</body>
</html>
